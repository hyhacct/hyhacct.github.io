{"title":"Gorm自动识别添加或更新记录","uid":"25294f8b7eb85e03a5a5598b5ec408ff","slug":"2025-08-22-01","date":"2025-08-22T13:00:07.000Z","updated":"2025-09-23T01:59:03.131Z","comments":true,"path":"api/articles/2025-08-22-01.json","keywords":null,"cover":null,"content":"<h2 id=\"介绍\"><a href=\"#介绍\" class=\"headerlink\" title=\"介绍\"></a>介绍</h2><p>写业务时需要用到 gorm 然后有个需求是根据某个字段(主键)来判断记录是否已存在,如果不存在,则创建这条记录,如果存在则更新.</p>\n<h2 id=\"上代码\"><a href=\"#上代码\" class=\"headerlink\" title=\"上代码\"></a>上代码</h2><div class=\"custom-quote tip\">\n<span class=\"custom-quote-svg\"><svg width=\"24\" height=\"24\" viewBox=\"0 0 24 24\" fill=\"\" xmlns=\"http://www.w3.org/2000/svg\" data-reactroot=\"\">\n<path fill=\"\" d=\"M20.86 14.13C20 14.7 19.56 15.74 19.77 16.76C20.13 18.55 18.55 20.13 16.76 19.77C15.74 19.57 14.7 20 14.13 20.86C13.12 22.38 10.89 22.38 9.88 20.86C9.3 20 8.26 19.56 7.24 19.77C5.45 20.13 3.87 18.55 4.23 16.76C4.43 15.74 4 14.7 3.14 14.13C1.62 13.12 1.62 10.89 3.14 9.88C4 9.3 4.44 8.26 4.23 7.24C3.87 5.45 5.45 3.87 7.24 4.23C8.26 4.44 9.3 4 9.87 3.14C10.88 1.62 13.11 1.62 14.12 3.14C14.7 4 15.74 4.44 16.76 4.23C18.55 3.87 20.13 5.45 19.77 7.24C19.56 8.26 20 9.3 20.86 9.87C22.38 10.88 22.38 13.12 20.86 14.13Z\" undefined=\"1\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M12.01 15C12.01 14.5 12.01 14.5 12.01 14.5C12.04 13.75 13 13.46 14.04 12.2C14.41 11.74 14.69 11.41 14.86 10.85C15.15 9.95 14.92 9.18 14.86 9.02C14.8 8.79 14.52 8 13.72 7.46C13.06 7.02 12.42 7 12.14 7C11.9 7 11.36 7 10.78 7.3C10.28 7.56 9.98 7.9 9.83 8.1C9.24 8.82 9.06 9.63 9 10.06\"></path>\n<path stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M11.99 18H12.01\"></path>\n</svg></span>\n<p class=\"custom-quote-title\">注意!!!</p>\n<p>这里<code>user_id</code>字段必须是唯一索引,必须带有<code>uniqueIndex</code>标签,因为 gorm 在判断记录是否存在时,就是根据这个字段来判断的,如果这个字段不是唯一索引,则不会触发<code>OnConflict</code></p>\n</div>\n<ul>\n<li>表结构</li>\n</ul>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">type</span> RealAuth <span class=\"keyword\">struct</span> &#123;</span><br><span class=\"line\">\tgorm.Model</span><br><span class=\"line\">\tUserID         <span class=\"type\">uint</span>   <span class=\"string\">`gorm:&quot;column:user_id;type:integer;comment:用户ID;not null;uniqueIndex&quot;`</span> <span class=\"comment\">// 用户ID,唯一索引</span></span><br><span class=\"line\">\tRealName       <span class=\"type\">string</span> <span class=\"string\">`gorm:&quot;column:real_name;type:varchar(255);comment:实名认证姓名&quot;`</span></span><br><span class=\"line\">\tIDCard         <span class=\"type\">string</span> <span class=\"string\">`gorm:&quot;column:id_card;type:varchar(255);comment:身份证号&quot;`</span></span><br><span class=\"line\">\tEthnicity      <span class=\"type\">string</span> <span class=\"string\">`gorm:&quot;column:ethnicity;type:varchar(255);comment:民族&quot;`</span></span><br><span class=\"line\">\tBirthDate      <span class=\"type\">string</span> <span class=\"string\">`gorm:&quot;column:birth_date;type:varchar(255);comment:出生日期&quot;`</span></span><br><span class=\"line\">\tSex            <span class=\"type\">string</span> <span class=\"string\">`gorm:&quot;column:sex;type:varchar(255);comment:性别&quot;`</span></span><br><span class=\"line\">\tAddress        <span class=\"type\">string</span> <span class=\"string\">`gorm:&quot;column:address;type:varchar(255);comment:住址&quot;`</span></span><br><span class=\"line\">\tIssueAuthority <span class=\"type\">string</span> <span class=\"string\">`gorm:&quot;column:issue_authority;type:varchar(255);comment:签发机关&quot;`</span></span><br><span class=\"line\">\tValidPeriod    <span class=\"type\">string</span> <span class=\"string\">`gorm:&quot;column:valid_period;type:varchar(255);comment:有效期&quot;`</span></span><br><span class=\"line\">\tIDCardFrontUrl <span class=\"type\">string</span> <span class=\"string\">`gorm:&quot;column:id_card_front_url;type:varchar(255);comment:身份证正面URL&quot;`</span></span><br><span class=\"line\">\tIDCardBackUrl  <span class=\"type\">string</span> <span class=\"string\">`gorm:&quot;column:id_card_back_url;type:varchar(255);comment:身份证反面URL&quot;`</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<ul>\n<li>代码</li>\n</ul>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">/*</span></span><br><span class=\"line\"><span class=\"comment\">更新或添加身份证正面照信息</span></span><br><span class=\"line\"><span class=\"comment\">1. ctx: 上下文</span></span><br><span class=\"line\"><span class=\"comment\">2. userID: 用户ID</span></span><br><span class=\"line\"><span class=\"comment\">3. resp: 身份证正面照信息</span></span><br><span class=\"line\"><span class=\"comment\">4. url: 身份证正面照在线URL</span></span><br><span class=\"line\"><span class=\"comment\">*/</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"params\">(r *userRepository)</span></span> UserRealAuth(ctx context.Context, userID <span class=\"type\">uint</span>, resp v1.OcrFrontContent, url <span class=\"type\">string</span>) <span class=\"type\">error</span> &#123;</span><br><span class=\"line\">\t<span class=\"comment\">// 如果记录不存在则创建,存在则更新</span></span><br><span class=\"line\">\trealAuth := model.RealAuth&#123;</span><br><span class=\"line\">\t\tUserID:         userID,</span><br><span class=\"line\">\t\tRealName:       resp.Name,</span><br><span class=\"line\">\t\tIDCard:         resp.IDNumber,</span><br><span class=\"line\">\t\tEthnicity:      resp.Ethnicity,</span><br><span class=\"line\">\t\tBirthDate:      resp.BirthDate,</span><br><span class=\"line\">\t\tSex:            resp.Sex,</span><br><span class=\"line\">\t\tAddress:        resp.Address,</span><br><span class=\"line\">\t\tIDCardFrontUrl: url,</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\t<span class=\"keyword\">return</span> r.DB(ctx).Model(&amp;model.RealAuth&#123;&#125;).Clauses(clause.OnConflict&#123;</span><br><span class=\"line\">\t\tColumns: []clause.Column&#123;&#123;Name: <span class=\"string\">&quot;user_id&quot;</span>&#125;&#125;,</span><br><span class=\"line\">\t\tDoUpdates: clause.AssignmentColumns([]<span class=\"type\">string</span>&#123;</span><br><span class=\"line\">\t\t\t<span class=\"string\">&quot;id_card_front_url&quot;</span>,</span><br><span class=\"line\">\t\t\t<span class=\"string\">&quot;real_name&quot;</span>,</span><br><span class=\"line\">\t\t\t<span class=\"string\">&quot;id_card&quot;</span>,</span><br><span class=\"line\">\t\t\t<span class=\"string\">&quot;ethnicity&quot;</span>,</span><br><span class=\"line\">\t\t\t<span class=\"string\">&quot;birth_date&quot;</span>,</span><br><span class=\"line\">\t\t\t<span class=\"string\">&quot;sex&quot;</span>,</span><br><span class=\"line\">\t\t\t<span class=\"string\">&quot;address&quot;</span>,</span><br><span class=\"line\">\t\t&#125;),</span><br><span class=\"line\">\t&#125;).Create(&amp;realAuth).Error</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"介绍-1\"><a href=\"#介绍-1\" class=\"headerlink\" title=\"介绍\"></a>介绍</h2><p>代码中,根据<code>user_id</code>来判断记录是否存在,如果存在则更新,不存在则创建,值得一提的时,<code>user_id</code>是唯一索引,也<strong>必须是唯一索引</strong>,所以不会出现重复创建的情况</p>\n<p>当发现<code>user_id</code>记录已存在时,则根据<code>clause.AssignmentColumns</code>里面提供的字段来更新记录,这里更新了</p>\n<ul>\n<li><code>id_card_front_url</code></li>\n<li><code>real_name</code></li>\n<li><code>id_card</code></li>\n<li><code>ethnicity</code></li>\n<li><code>birth_date</code></li>\n<li><code>sex</code></li>\n<li><code>address</code></li>\n</ul>\n","feature":false,"text":"介绍写业务时需要用到 gorm 然后有个需求是根据某个字段(主键)来判断记录是否已存在,如果不存在,则创建这条记录,如果存在则更新. 上代码 注意!!! 这里u...","permalink":"/post/2025-08-22-01","photos":[],"count_time":{"symbolsCount":"2.5k","symbolsTime":"2 mins."},"categories":[{"name":"Go","slug":"Go","count":4,"path":"api/categories/Go.json"}],"tags":[{"name":"Go","slug":"Go","count":2,"path":"api/tags/Go.json"}],"toc":"<ol class=\"toc\"><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#%E4%BB%8B%E7%BB%8D\"><span class=\"toc-text\">介绍</span></a></li><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#%E4%B8%8A%E4%BB%A3%E7%A0%81\"><span class=\"toc-text\">上代码</span></a></li><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#%E4%BB%8B%E7%BB%8D-1\"><span class=\"toc-text\">介绍</span></a></li></ol>","author":{"name":"Reverse","slug":"blog-author","avatar":"/images/avatar.jpg","link":"/","description":"每一次的突破，都是自我超越的见证。","socials":{"github":"https://github.com/hyhacct","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"","zhihu":"","csdn":"","juejin":"","customs":{}}},"mapped":true,"hidden":false,"prev_post":{"title":"让你的Vue代码更规范","uid":"8319071f86b64a3c388c84f965817220","slug":"2025-09-03-01","date":"2025-09-03T17:23:39.000Z","updated":"2025-09-23T01:59:03.131Z","comments":true,"path":"api/articles/2025-09-03-01.json","keywords":null,"cover":null,"text":"用到的工具如果使用的是cursor或者vscode,强烈建议安装以下几个插件: ESLint 代码规范工具 Prettier - Code formatter ...","permalink":"/post/2025-09-03-01","photos":[],"count_time":{"symbolsCount":"2.6k","symbolsTime":"2 mins."},"categories":[{"name":"Vue.js","slug":"Vue-js","count":6,"path":"api/categories/Vue-js.json"}],"tags":[{"name":"Vue.js","slug":"Vue-js","count":3,"path":"api/tags/Vue-js.json"}],"author":{"name":"Reverse","slug":"blog-author","avatar":"/images/avatar.jpg","link":"/","description":"每一次的突破，都是自我超越的见证。","socials":{"github":"https://github.com/hyhacct","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"","zhihu":"","csdn":"","juejin":"","customs":{}}},"feature":false},"next_post":{"title":"通过Let’s Encrypt申请SSL泛域名证书","uid":"8d7719b423036d3eee5f283084ac02fe","slug":"2025-08-16-01","date":"2025-08-16T10:14:52.000Z","updated":"2025-09-23T01:59:03.131Z","comments":true,"path":"api/articles/2025-08-16-01.json","keywords":null,"cover":[],"text":"介绍Let’s Encrypt 是一个免费的、自动化、开放的证书颁发机构，为网站提供 HTTPS 加密。它使用 ACME 协议来验证域名所有权，并颁发免费的 S...","permalink":"/post/2025-08-16-01","photos":[],"count_time":{"symbolsCount":"3.9k","symbolsTime":"4 mins."},"categories":[{"name":"运维","slug":"运维","count":10,"path":"api/categories/运维.json"}],"tags":[{"name":"运维","slug":"运维","count":3,"path":"api/tags/运维.json"}],"author":{"name":"Reverse","slug":"blog-author","avatar":"/images/avatar.jpg","link":"/","description":"每一次的突破，都是自我超越的见证。","socials":{"github":"https://github.com/hyhacct","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"","zhihu":"","csdn":"","juejin":"","customs":{}}},"feature":false}}