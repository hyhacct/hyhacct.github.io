{"title":"Categref心跳报错","uid":"4cbb08f3981d46e2c18366238303babb","slug":"2025-07-19-01","date":"2025-07-19T14:28:14.000Z","updated":"2025-09-03T09:27:53.509Z","comments":true,"path":"api/articles/2025-07-19-01.json","keywords":null,"cover":[],"content":"<h2 id=\"描述\"><a href=\"#描述\" class=\"headerlink\" title=\"描述\"></a>描述</h2><p>之前在工作中碰到的问题，在容器环境中运行夜莺的<code>categref</code>采集器会出现心跳失败的情况，如下：</p>\n<figure class=\"highlight txt\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">root@localhost:/apps/data# /usr/local/bin/categraf --configs /apps/data/.gitrce/categraf/conf</span><br><span class=\"line\">2024/12/10 22:06:57 main.go:149: I! runner.binarydir: /usr/local/bin</span><br><span class=\"line\">2024/12/10 22:06:57 main.go:150: I! runner.hostname: localhost.localdomain</span><br><span class=\"line\">2024/12/10 22:06:57 main.go:151: I! runner.fd_limits: (soft=1048576, hard=1048576)</span><br><span class=\"line\">2024/12/10 22:06:57 main.go:152: I! runner.vm_limits: (soft=unlimited, hard=unlimited)</span><br><span class=\"line\">2024/12/10 22:06:57 provider_manager.go:60: I! use input provider: [local]</span><br><span class=\"line\">2024/12/10 22:06:57 prometheus_agent.go:19: I! prometheus scraping disabled!</span><br><span class=\"line\">2024/12/10 22:06:57 ibex_agent.go:19: I! ibex agent disabled!</span><br><span class=\"line\">2024/12/10 22:06:57 agent.go:38: I! agent starting</span><br><span class=\"line\">2024/12/10 22:06:57 metrics_agent.go:319: I! input: local.cpu started</span><br><span class=\"line\">2024/12/10 22:06:57 diskio.go:64: E! failed to get disk io: open /hostfs/proc/diskstats: no such file or directory</span><br><span class=\"line\">2024/12/10 22:06:57 metrics_agent.go:319: I! input: local.diskio started</span><br><span class=\"line\">2024/12/10 22:06:57 metrics_agent.go:319: I! input: local.ipmi started</span><br><span class=\"line\">2024/12/10 22:06:57 metrics_agent.go:319: I! input: local.mem started</span><br><span class=\"line\">2024/12/10 22:06:57 net.go:65: E! failed to get net io metrics: open /hostfs/proc/net/dev: no such file or directory</span><br><span class=\"line\">2024/12/10 22:06:57 metrics_agent.go:319: I! input: local.net started</span><br><span class=\"line\">2024/12/10 22:06:57 metrics_agent.go:319: I! input: local.netstat started</span><br><span class=\"line\">2024/12/10 22:06:57 netstat.go:69: E! failed to read sockstat /hostfs/proc/net/sockstat open /hostfs/proc/net/sockstat: no such file or directory</span><br><span class=\"line\">2024/12/10 22:06:57 diskstats_common.go:99: I! Parsing flag --collector.diskstats.device-exclude flag ^(z?ram|loop|fd|(h|s|v|xv)d[a-z]|nvme\\d+n\\d+p)\\d+$</span><br><span class=\"line\">2024/12/10 22:06:57 metrics_agent.go:319: I! input: local.node_exporter started</span><br><span class=\"line\">2024/12/10 22:06:57 collector.go:189: I! collector succeeded name filenotify duration_seconds 0.000130781</span><br><span class=\"line\">2024/12/10 22:06:57 collector.go:189: I! collector succeeded name netdev duration_seconds 0.000965317</span><br><span class=\"line\">2024/12/10 22:06:57 collector.go:189: I! collector succeeded name diskstats duration_seconds 0.001339931</span><br><span class=\"line\">2024/12/10 22:06:57 collector.go:189: I! collector succeeded name netstat duration_seconds 0.001483027</span><br><span class=\"line\">2024/12/10 22:06:57 metrics_agent.go:319: I! input: local.smart started</span><br><span class=\"line\">2024/12/10 22:06:57 metrics_agent.go:319: I! input: local.system started</span><br><span class=\"line\">2024/12/10 22:06:57 system.go:46: E! failed to gather cpu number: open /hostfs/proc/stat: no such file or directory</span><br><span class=\"line\">2024/12/10 22:06:57 agent.go:46: I! [*agent.MetricsAgent] started</span><br><span class=\"line\">2024/12/10 22:06:57 agent.go:49: I! agent started</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">2024/12/10 22:07:00 heartbeat.go:150: E! failed to marshal heartbeat request: json: unsupported value: NaN // [!code error]</span><br><span class=\"line\"></span><br><span class=\"line\">^C2024/12/10 22:07:01 main.go:131: I! received signal: interrupt</span><br><span class=\"line\">2024/12/10 22:07:01 agent.go:53: I! agent stopping</span><br><span class=\"line\">2024/12/10 22:07:01 agent.go:61: I! [*agent.MetricsAgent] stopped</span><br><span class=\"line\">2024/12/10 22:07:01 agent.go:64: I! agent stopped</span><br><span class=\"line\">2024/12/10 22:07:01 main.go:144: I! exited</span><br><span class=\"line\">root@localhost:/apps/data#</span><br></pre></td></tr></table></figure>\n\n<p><img src=\"/images/essay/2025-07-19-01/001.png\"></p>\n<p>在这里出现了一个<code>NaN</code>的报错，然后我在 GitHub 上提交了一个<a href=\"https://github.com/flashcatcloud/categraf/issues/1106\">issue</a>，并且得到了解决方案</p>\n<h2 id=\"解决方案\"><a href=\"#解决方案\" class=\"headerlink\" title=\"解决方案\"></a>解决方案</h2><p>有位大佬提供了两个解决方案，我大概看了下，应该是我启动容器时的<code>env环境</code>的问题</p>\n<p><img src=\"/images/essay/2025-07-19-01/002.png\"></p>\n<p>按照大佬所说的，我在容器启动配置中将<code>HOST_PROC</code>这个参数删掉了，然后重建容器，再次查看，心跳正常，问题成功解决！</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"built_in\">cat</span> &gt;<span class=\"variable\">$_compose_file</span> &lt;&lt;<span class=\"string\">EOF</span></span><br><span class=\"line\"><span class=\"string\">services:</span></span><br><span class=\"line\"><span class=\"string\">  master:</span></span><br><span class=\"line\"><span class=\"string\">    container_name: $_container_name</span></span><br><span class=\"line\"><span class=\"string\">    image: $_image2</span></span><br><span class=\"line\"><span class=\"string\">    restart: always</span></span><br><span class=\"line\"><span class=\"string\">    network_mode: host</span></span><br><span class=\"line\"><span class=\"string\">    ipc: host</span></span><br><span class=\"line\"><span class=\"string\">    uts: host</span></span><br><span class=\"line\"><span class=\"string\">    privileged: true</span></span><br><span class=\"line\"><span class=\"string\">    security_opt:</span></span><br><span class=\"line\"><span class=\"string\">      - apparmor:unconfined</span></span><br><span class=\"line\"><span class=\"string\">    environment:</span></span><br><span class=\"line\"><span class=\"string\">      - TINI_SUBREAPER=1</span></span><br><span class=\"line\"><span class=\"string\">      - GIT_REMOTE_REPO=$_gre_remote_repo</span></span><br><span class=\"line\"><span class=\"string\">      - APPS_DATA=$_apps_data</span></span><br><span class=\"line\"><span class=\"string\">      - CONTAINER_NAME=$_container_name</span></span><br><span class=\"line\"><span class=\"string\">      - HOST_PROC=/hostfs/proc // [!code --]</span></span><br><span class=\"line\"><span class=\"string\">      - HOST_MOUNT_PREFIX=/hostfs</span></span><br><span class=\"line\"><span class=\"string\">EOF</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n","feature":false,"text":"描述之前在工作中碰到的问题，在容器环境中运行夜莺的categref采集器会出现心跳失败的情况，如下： 12345678910111213141516171819...","permalink":"/post/2025-07-19-01","photos":[],"count_time":{"symbolsCount":"3.7k","symbolsTime":"3 mins."},"categories":[{"name":"疑难杂症","slug":"疑难杂症","count":1,"path":"api/categories/疑难杂症.json"}],"tags":[{"name":"Categref 夜莺","slug":"Categref-夜莺","count":1,"path":"api/tags/Categref-夜莺.json"}],"toc":"<ol class=\"toc\"><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#%E6%8F%8F%E8%BF%B0\"><span class=\"toc-text\">描述</span></a></li><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88\"><span class=\"toc-text\">解决方案</span></a></li></ol>","author":{"name":"Reverse","slug":"blog-author","avatar":"/images/avatar.jpg","link":"/","description":"每一次的突破，都是自我超越的见证。","socials":{"github":"https://github.com/hyhacct","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"","zhihu":"","csdn":"","juejin":"","customs":{}}},"mapped":true,"hidden":false,"prev_post":{"title":"Docker守护进程连接错误","uid":"11dfc50955afa32461ac370ac3e78a2c","slug":"2025-07-19-02","date":"2025-07-19T14:34:01.000Z","updated":"2025-09-03T09:27:53.509Z","comments":true,"path":"api/articles/2025-07-19-02.json","keywords":null,"cover":null,"text":"问题描述在使用 docker 时，发现 docker 守护进程出现连接错误，如下： 123[root@localhost ~]# docker restart ...","permalink":"/post/2025-07-19-02","photos":[],"count_time":{"symbolsCount":"15k","symbolsTime":"13 mins."},"categories":[{"name":"Docker","slug":"Docker","count":1,"path":"api/categories/Docker.json"}],"tags":[{"name":"Docker","slug":"Docker","count":1,"path":"api/tags/Docker.json"}],"author":{"name":"Reverse","slug":"blog-author","avatar":"/images/avatar.jpg","link":"/","description":"每一次的突破，都是自我超越的见证。","socials":{"github":"https://github.com/hyhacct","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"","zhihu":"","csdn":"","juejin":"","customs":{}}},"feature":false},"next_post":{"title":"在Ubuntu下安装sysbox","uid":"801add81576d2589d371217217c13cbc","slug":"2025-07-18-15","date":"2025-07-18T17:54:02.000Z","updated":"2025-09-03T09:27:53.509Z","comments":true,"path":"api/articles/2025-07-18-15.json","keywords":null,"cover":null,"text":"旧版本应该存在一些问题,某些场景下 docker 的功能不兼容或者不可用,在 dind 中更明显,所以直接安装最高版本. 1234567# 这里需要把容器先全部...","permalink":"/post/2025-07-18-15","photos":[],"count_time":{"symbolsCount":327,"symbolsTime":"1 mins."},"categories":[{"name":"运维","slug":"运维","count":10,"path":"api/categories/运维.json"}],"tags":[{"name":"sysbox","slug":"sysbox","count":1,"path":"api/tags/sysbox.json"}],"author":{"name":"Reverse","slug":"blog-author","avatar":"/images/avatar.jpg","link":"/","description":"每一次的突破，都是自我超越的见证。","socials":{"github":"https://github.com/hyhacct","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"","zhihu":"","csdn":"","juejin":"","customs":{}}}}}